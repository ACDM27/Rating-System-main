# 实施计划：辩论赛投票系统

## 概述

将现有的AI课程答辩评分系统转换为辩论赛投票系统。保持当前的Vue 3 + FastAPI + PostgreSQL技术栈，通过最小化的数据库模式变更和界面适配来实现功能转换。

## 任务

- [x] 1. 数据库模式更新和核心模型转换
  - 创建新的数据库迁移文件
  - 更新User模型以支持辩论角色（judge, audience）
  - 创建Contest、VoteRecord、JudgeScore模型
  - 更新SystemSettings模型以支持辩论阶段
  - _需求: 1.1, 7.1, 7.2_

- [ ]* 1.1 为核心数据模型编写属性测试
  - **属性13: 配置数据持久化**
  - **验证: 需求 7.1, 7.2**

- [ ] 2. 后端API端点转换
  - [x] 2.1 更新认证系统以支持新角色
    - 修改登录逻辑以处理judge和audience角色
    - 更新角色验证中间件
    - _需求: 1.1, 1.2, 1.3_

  - [ ]* 2.2 为角色认证编写属性测试
    - **属性1: 基于角色的界面交付**
    - **验证: 需求 1.1, 1.2, 1.3**

  - [x] 2.3 实现投票API端点
    - 创建投票提交端点
    - 实现投票配额验证逻辑
    - 添加投票重复检查
    - _需求: 3.3, 3.5_

  - [ ]* 2.4 为投票系统编写属性测试
    - **属性4: 观众投票配额执行**
    - **验证: 需求 3.3, 3.5**

  - [x] 2.5 实现评委评分API端点
    - 创建评分提交端点
    - 实现六维度评分验证
    - 添加评分不可变性控制
    - _需求: 2.2, 2.3, 2.5_

  - [ ]* 2.6 为评委评分编写属性测试
    - **属性2: 评委评分验证**
    - **属性3: 评分提交不可变性**
    - **验证: 需求 2.2, 2.3, 2.5**

- [x] 3. 检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户。

- [ ] 4. 计算引擎实现
  - [x] 4.1 实现跑票计算逻辑
    - 创建跑票值计算函数
    - 实现队伍获胜者确定逻辑
    - _需求: 4.1, 4.2_

  - [ ]* 4.2 为跑票计算编写属性测试
    - **属性5: 跑票计算准确性**
    - **属性6: 队伍获胜者确定**
    - **验证: 需求 4.1, 4.2**

  - [x] 4.3 实现辩手排名计算
    - 创建评分平均计算函数
    - 实现平分决胜逻辑
    - _需求: 5.1, 5.2, 5.3_

  - [ ]* 4.4 为辩手排名编写属性测试
    - **属性7: 个人辩手评分平均**
    - **属性8: 辩手排名平分决胜逻辑**
    - **验证: 需求 5.1, 5.2, 5.3**

- [ ] 5. 系统状态管理更新
  - [x] 5.1 更新系统状态控制逻辑
    - 实现辩论阶段状态机
    - 添加互斥阶段控制
    - 更新WebSocket广播逻辑
    - _需求: 6.1, 6.2_

  - [ ]* 5.2 为状态管理编写属性测试
    - **属性9: 系统阶段互斥**
    - **属性10: 实时状态广播**
    - **验证: 需求 6.1, 6.2**

  - [x] 5.3 实现访问控制和结果揭晓
    - 添加管理员专用进度可见性
    - 实现结果揭晓访问控制
    - _需求: 6.3, 6.5_

  - [ ]* 5.4 为访问控制编写属性测试
    - **属性11: 仅管理员进度可见性**
    - **属性12: 结果揭晓访问控制**
    - **验证: 需求 6.3, 6.5**

- [ ] 6. 前端界面转换
  - [x] 6.1 转换管理员界面
    - 更新流程控制按钮为辩论阶段
    - 添加比赛配置界面
    - 修改进度监控显示
    - _需求: 6.1, 7.1_

  - [x] 6.2 创建评委移动端界面
    - 实现标签式导航（正方/反方）
    - 创建手风琴式辩手卡片
    - 添加六维度评分表单
    - 实现移动端优化（触摸友好、数字键盘）
    - _需求: 2.1, 2.2, 9.2, 9.4_

  - [x] 6.3 创建观众移动端界面
    - 实现分屏投票布局（正方红/反方蓝）
    - 创建大触摸按钮（最小60px）
    - 添加加载状态和确认反馈
    - _需求: 3.1, 3.2, 3.4, 9.3_

  - [x] 6.4 更新展示屏幕界面
    - 修改显示内容为投票进度
    - 实现信息过滤（隐藏投票分布）
    - 添加结果揭晓动画
    - _需求: 8.1, 8.3, 8.4_
    - _需求: 8.1, 8.3, 8.4_

- [ ]* 6.5 为界面组件编写单元测试
  - 测试移动端响应式布局
  - 测试触摸交互功能
  - 测试表单验证和提交

- [ ] 7. 检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户。

- [ ] 8. 数据导出和审计功能
  - [ ] 8.1 实现结果导出功能
    - 创建Excel导出功能
    - 包含所有评分、投票和计算数据
    - _需求: 10.1_

  - [ ]* 8.2 为导出功能编写属性测试
    - **属性17: 导出数据完整性**
    - **验证: 需求 10.1**

  - [ ] 8.3 实现审计跟踪系统
    - 添加所有操作的时间戳记录
    - 实现计算步骤保存
    - _需求: 10.2, 10.3_

  - [ ]* 8.4 为审计系统编写属性测试
    - **属性16: 审计跟踪完整性**
    - **属性18: 计算保存**
    - **验证: 需求 10.2, 10.3**

- [ ] 9. 集成测试和系统验证
  - [ ] 9.1 实现端到端测试场景
    - 测试完整的辩论流程
    - 验证所有角色交互
    - 测试移动端和桌面端兼容性
    - _需求: 所有需求_

  - [ ]* 9.2 运行所有属性测试套件
    - 验证所有18个正确性属性
    - 确保100次迭代测试通过
    - 记录任何失败的反例

- [ ] 10. 最终检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户。

## 注意事项

- 标记为 `*` 的任务是可选的，可以跳过以加快MVP开发
- 每个任务都引用了具体需求以便追溯
- 检查点确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证具体示例和边缘情况