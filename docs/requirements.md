# AI 课程答辩评分系统需求文档 (v1.0)

## 1. 项目概述

本项目旨在为AI课程设计一套全流程的数字化答辩评分系统。系统支持多角色（教师、学生团队、管理员、大屏）协同工作，通过WebSocket实现低延迟的状态同步，完成评分、互评、抢答和提问质量评估，最终自动生成综合成绩。

### 1.1 技术栈

- **前端**：Vue 3 + Vite + Axios + Pinia (状态管理) + Element Plus (UI组件库)
- **后端**：Python FastAPI
- **数据库**：PostgreSQL
- **ORM**：SQLAlchemy (配合 Pydantic 进行数据验证)
- **通信协议**：HTTP (RESTful API) + WebSocket (实时通信)

---

## 2. 核心业务逻辑与分数算法

### 2.1 角色定义 (`role` 字段区分)

1. **管理员 (Admin)**：唯一的上帝视角，登录后台控制全场流程状态，配置用户，并在最后对学生提问进行打分。
2. **教师 (Teacher)**：登录教师端，对正在答辩的团队进行专业评分（50分权重）。
3. **学生团队 (Student)**：以团队账号（如 `Team01`）登录。
   - **作为答辩者时**：在大屏显示其信息。
   - **作为观众时**：对台上的团队进行评分（30分权重），并参与抢答（20分权重）。
4. **大屏 (Screen)**：无登录或只读账号，实时接收WebSocket消息，展示当前环节、倒计时、问题墙和最终排行榜。

### 2.2 最终得分公式

系统对每个团队 $i$ 计算总分 $S_i$：

$$S_i = \text{TeacherScore}_i + \text{PeerScore}_i + \text{AskQualityScore}_i$$

- **TeacherScore (满分50)**:
  - $\frac{\sum \text{所有教师对} i \text{的评分}}{\text{教师人数}}$
- **PeerScore (满分30)**:
  - $\frac{\sum \text{其他团队对} i \text{的评分}}{\text{其他团队数}}$
- **AskQualityScore (满分20)**:
  - 该部分属于**参与分**。团队 $i$ 在观看其他团队答辩时，成功抢答并提出的问题，由教师/管理员在事后打分。
  - 公式：$\frac{\sum \text{团队} i \text{提出的所有问题的得分}}{3}$
  - *注：每个团队最多可提问3个问题。如果提问数少于3个，计算平均分时仍以3为分母。若未提问，该项为0。*

---

## 3. 数据库设计 (ERD 概念)

### 3.1 表结构设计

**1. users (用户表)**

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | PK, int | 主键 |
| `username` | String, unique | 登录名 (e.g., "admin", "teacher01", "team01") |
| `password_hash` | String | 密码哈希 |
| `role` | Enum | `admin`, `teacher`, `student` |
| `display_name` | String | 显示名称 (e.g., "第一组-AI绘画") |

**2. score_records (评分记录表 - 存储打分)**

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | PK, int | 主键 |
| `scorer_id` | FK -> users.id | 打分人ID |
| `target_team_id` | FK -> users.id | 被打分团队ID |
| `phase` | Enum | `teacher_eval` (教师评分), `student_eval` (学生互评) |
| `score_details` | JSON | 存储各细项得分 (e.g., `{"completeness": 9, "quality": 18...}`) |
| `total_score` | Float | 该次打分总和 |
| `created_at` | Datetime | 创建时间 |

> **Constraint**: 联合唯一索引 (`scorer_id`, `target_team_id`)

**3. questions (提问表 - 存储抢答及问题)**

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | PK, int | 主键 |
| `asker_team_id` | FK -> users.id | 提问团队ID |
| `target_team_id` | FK -> users.id | 被提问团队ID (台上团队) |
| `content` | Text | 问题内容 |
| `quality_score` | Float, nullable | 问题质量分 (0-20)，由管理员后期打分 |
| `status` | Enum | `snatched` (仅抢到坑位), `submitted` (已提交内容) |
| `created_at` | Datetime | 创建时间 |

**4. system_settings (系统状态表 - 单行记录)**

| 字段 | 类型 | 说明 |
|------|------|------|
| `current_stage` | Enum | 当前阶段（见下方说明） |
| `current_team_id` | FK -> users.id | 当前正在台上的团队 |
| `snatch_slots_remaining` | int | 剩余抢答名额 (初始3) |

**current_stage 枚举值**:
- `IDLE` - 未开始
- `PRESENTATION` - 答辩中
- `QNA_SNATCH` - 抢答环节
- `QNA_INPUT` - 提问输入环节 (可选，或合并在抢答中)
- `SCORING_TEACHER` - 教师评分中
- `SCORING_STUDENT` - 学生互评中
- `FINISHED` - 当前团队结束

---

## 4. 接口设计 (API & WebSocket)

### 4.1 WebSocket 协议

所有客户端连接 `/ws/{client_id}`。

#### 服务端推送消息 (Server -> Client)

**状态更新消息**:
```json
{
  "type": "STATE_UPDATE",
  "data": {
    "stage": "SCORING_STUDENT",
    "current_team": {"id": 2, "name": "第二组"},
    "snatch_remaining": 3
  }
}
```

**评分进度消息**:
```json
{
  "type": "SCORE_PROGRESS",
  "data": {
    "submitted_count": 15,
    "total_count": 20
  }
}
```

**新问题消息 (用于大屏展示)**:
```json
{
  "type": "NEW_QUESTION",
  "data": {
    "asker_name": "第一组",
    "content": "你们的模型准确率是多少？"
  }
}
```

#### 客户端发送消息 (Client -> Server)

- **学生端**: `{"action": "SNATCH"}` (仅在 `QNA_SNATCH` 阶段有效)

### 4.2 核心 HTTP API

#### Auth
| 方法 | 路径 | 说明 |
|------|------|------|
| POST | `/auth/login` | 登录 |

#### Flow Control (Admin Only)
| 方法 | 路径 | 说明 |
|------|------|------|
| POST | `/admin/stage/set` | 切换系统阶段 (参数: `stage`, `target_team_id`) |
| GET | `/admin/progress` | 获取当前评分/提问进度 |

#### Scoring
| 方法 | 路径 | 说明 |
|------|------|------|
| POST | `/score/submit` | 提交评分 (教师/学生用) |

> **Backend Check**: 禁止 `scorer_id == target_team_id`。  
> **Backend Check**: 如果当前阶段不对，拒绝提交。

#### Questions
| 方法 | 路径 | 说明 |
|------|------|------|
| POST | `/question/submit_content` | 抢答成功后，提交具体问题文本 |
| POST | `/question/grade` | (后期) 管理员给问题打分 |

#### Data
| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/dashboard/realtime` | 大屏获取当前展示数据 |
| GET | `/dashboard/rank` | 获取最终排行榜 (计算所有公式) |

---

## 5. 功能模块详细需求

### 5.1 后台管理端 (Admin)

#### 1. 用户管理
简单的 CRUD，创建 `admin`, `teacher1..N`, `team01..N`。

#### 2. 流程控制台 (核心功能)

- 下拉选择"当前答辩团队"。
- **大按钮操作流**:
  1. `[开始答辩]`: 大屏显示团队信息。
  2. `[开启抢答]`: 学生端显示抢答按钮，大屏显示倒计时(60s)。
  3. `[开启教师评分]`: 教师端解锁评分卡。
  4. `[开启互评]`: 学生端解锁评分卡。
     - *监控面板*: 实时显示"已提交 X / 总人数 Y"，显示谁还没交。
  5. `[结束本组]`: 汇总分数，大屏展示本组得分。

#### 3. 提问评分页
- 所有团队答辩结束后使用。
- 列表展示所有 `questions`，管理员输入 `quality_score` (0-20) 并保存。

#### 4. 数据导出
导出 Excel (包含各细项得分、总分)。

---

### 5.2 教师端 (Teacher)

#### 1. 等待页
当系统不在 `SCORING_TEACHER` 阶段时，显示"等待中..."。

#### 2. 评分页
- 接收到 WebSocket 状态变更为 `SCORING_TEACHER` 时自动刷新。
- 表单：《教师评分表》
  - 内容完整性: 10分
  - 成果质量: 20分
  - 表达展示: 10分
  - 答辩表现: 10分
- 提交后显示"等待下一组"。

---

### 5.3 学生端 (Student - Team Account)

#### 1. 等待页
默认状态。显示"当前答辩：XX组"。

#### 2. 互评页
- 状态变更为 `SCORING_STUDENT` 时进入。
- **逻辑判断**: 如果 `current_team_id == my_id`，显示"您的团队正在被评分"，**禁止打分**。
- 表单：《学生评分表》
  - 展示内容: 10分
  - 团队协作: 10分
  - 互动答辩: 10分
- *阻塞*: 必须提交才能进入后续流程（或者等管理员强制切状态）。

#### 3. 抢答页
- 状态变更为 `QNA_SNATCH` 时进入。
- 显示"剩余名额: X/3"。
- 显示巨大按钮 `[抢答]`。
- **逻辑**:
  - 点击 -> 发送 WebSocket 请求。
  - 若成功 -> 跳转至 **提问输入页**。
  - 若失败 (名额已满) -> 显示"抢答结束"，按钮置灰。
  - 若自己是台上的团队 -> 按钮禁用，显示"请准备回答问题"。
  - *限制*: 每个团队对每个台上团队只能抢1次，整个答辩过程中最多抢答3次。

#### 4. 提问输入页
- 倒计时或不限时（建议跟随系统大状态）。
- 输入文本框 -> 提交 -> 显示在大屏。

---

### 5.4 大屏展示端 (Screen)

#### 1. 信息展示
当前团队名、成员。

#### 2. 实时反馈
- 评分阶段：显示"教师评分中..."、"学生互评中..."。
- 结果展示：教师分出炉后，通过柱状图或大数字展示。

#### 3. 抢答墙
- 显示 3 个空槽位。
- 有人抢到时，槽位亮起显示"Team XX 正在提问..."。
- 问题提交后，直接显示具体问题内容。

#### 4. 最终排行榜
按总分降序排列。

---

## 6. 特殊业务场景处理

### 6.1 评分防呆
学生端如果尝试跳过评分接口直接调用抢答，后端需校验 `has_scored` 状态。考虑到简化开发，以后台强切状态为主，若学生在 `SCORING_STUDENT` 阶段结束时仍未提交，后端默认记为弃权（该团队对台上的打分视为0或不计入分母，建议不计入分母以防拉低分数，或者由管理员在后台大吼一声催促）。

### 6.2 抢答并发
使用 Redis 原子操作或 Python `asyncio.Lock` 确保抢答名额不会超卖（严格限制3个）。

**抢答规则**:
- 每轮答辩（每个台上团队）有 3 个抢答名额
- 每个观众团队对当前台上团队最多只能抢到 1 个名额
- 每个团队在整个答辩过程中最多可提问 3 次

### 6.3 断线重连
前端页面刷新时，`onMounted` 调用 API 获取当前 `SystemState`，确保页面自动恢复到正确的环节。

---

## 7. 开发计划建议

| 阶段 | 内容 | 说明 |
|------|------|------|
| **第一步** | 后端核心 | 搭建 FastAPI + PGSQL，实现 User 和 SystemState 的 CRUD，跑通 WebSocket 广播 |
| **第二步** | 管理端 | 实现流程控制面板，这是驱动整个系统的引擎 |
| **第三步** | 客户端 | 完成学生端评分和教师端评分页面 |
| **第四步** | 抢答 | 攻克抢答的高并发逻辑（虽然并发量小，但逻辑要严密）和提问录入 |
| **第五步** | 大屏 & 报表 | 数据可视化和最终算分逻辑 |

---

## 附录：评分表细项

### 教师评分表 (满分50分)

| 评分项 | 分值 | 说明 |
|--------|------|------|
| 内容完整性 | 10 | 答辩内容是否完整涵盖项目要点 |
| 成果质量 | 20 | 项目成果的技术水平和创新程度 |
| 表达展示 | 10 | PPT质量、演讲表达能力 |
| 答辩表现 | 10 | 回答问题的准确性和应变能力 |

### 学生互评表 (满分30分)

| 评分项 | 分值 | 说明 |
|--------|------|------|
| 展示内容 | 10 | 展示内容的清晰度和吸引力 |
| 团队协作 | 10 | 团队成员配合程度 |
| 互动答辩 | 10 | 与观众互动和答辩的表现 |

### 提问质量分 (满分20分)

- 由管理员/教师在答辩结束后统一评分
- 每个问题满分 20 分
- 团队得分 = 所有问题得分之和 / 3（不足3个问题仍以3为分母）
