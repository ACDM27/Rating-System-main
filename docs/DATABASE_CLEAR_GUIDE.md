# 数据库清空操作指南

## ⚠️ 警告
此操作将**永久删除**数据库中的所有数据（管理员账号除外），且**无法恢复**！

## 🎯 清空范围

### 将被删除的数据
- ✅ 所有场次（classes）
- ✅ 所有观众账号（role=audience）
- ✅ 所有评委账号（role=judge）
- ✅ 所有辩手数据
- ✅ 所有比赛记录（contests）
- ✅ 所有投票记录（vote_records）
- ✅ 所有评分记录（judge_scores）
- ✅ 所有系统设置（system_settings）
- ✅ 所有评委-场次关联（teacher_classes）

### 将被保留的数据
- ✅ 所有管理员账号（role=admin）
- ✅ 工作空间（workspaces）

## 📝 使用步骤

### 1. 备份数据库（强烈建议）

```bash
# 进入backend目录
cd backend

# 备份数据库
copy vote.db vote.db.backup_20260116
```

### 2. 运行清空脚本

```bash
# 运行清空脚本
python clear_database.py
```

### 3. 确认操作

脚本会显示当前数据统计并要求确认：
```
确认执行清空操作？(输入 YES 确认):
```

输入 `YES`（必须大写）确认执行。

### 4. 查看结果

脚本会显示清空进度和最终结果：
```
✓ 已删除所有系统设置
✓ 已删除所有评分记录
✓ 已删除所有投票记录
✓ 已删除所有比赛
✓ 已删除所有评委-场次关联
✓ 已删除所有场次
✓ 已删除 X 个非管理员用户

数据库清空完成！

保留的管理员账号:
  ID: 1, 用户名: admin, 显示名: 系统管理员
```

### 5. 重启后端服务

```bash
# 停止当前后端服务（Ctrl+C）
# 重新启动
python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

## 🔧 清空后的系统状态

### 登录信息
- 管理员账号：`admin`
- 密码：`admin123`（或您设置的密码）

### 需要重新配置的内容
1. 创建新场次
2. 添加观众账号
3. 添加评委账号
4. 创建比赛
5. 分配辩手

## 🚨 常见问题

### Q: 如果误操作了怎么办？
**A:** 如果已经执行了清空操作，只能从备份恢复：
```bash
# 停止后端服务
# 恢复备份
copy vote.db.backup_20260116 vote.db
# 重启服务
```

### Q: 能不能只清空某个场次的数据？
**A:** 可以在控制台使用"重置系统"功能，这会清空当前场次的数据但保留账号。

### Q: 清空后需要重新初始化数据库吗？
**A:** 不需要。数据库结构保持不变，只是数据被清空了。

### Q: 管理员密码忘记了怎么办？
**A:** 可以使用 `backend/reset_admin_password.py` 脚本重置管理员密码（需要单独创建）。

## 📊 执行流程图

```
开始
  ↓
备份数据库
  ↓
运行 clear_database.py
  ↓
查看数据统计
  ↓
输入 YES 确认
  ↓
删除系统设置
  ↓
删除评分记录
  ↓
删除投票记录
  ↓
删除比赛
  ↓
删除场次
  ↓
删除非管理员用户
  ↓
重启后端服务
  ↓
完成
```

## 🔐 安全提示

1. **务必备份**：执行清空前务必备份数据库
2. **确认环境**：确保在正确的环境（开发/生产）执行
3. **通知用户**：如果是生产环境，提前通知所有用户
4. **保留日志**：记录清空操作的时间和原因
5. **测试恢复**：在测试环境先验证备份恢复流程

## 📞 技术支持

如有问题，请联系系统管理员或查看项目文档。
